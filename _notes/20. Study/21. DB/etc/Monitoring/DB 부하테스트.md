- [[#부하 스크립트 구성|부하 스크립트 구성]]
- [[#Lock 발생 시키기|Lock 발생 시키기]]

### 부하 스크립트 구성
*파일 구성* (파일: 00. Inbox > db-load.tar)
- **SQL 스크립트:**
    - `data/db-load/db-load/oracle/load_temp_tablespace.sql`
    - `data/db-load/db-load/oracle/load_undo_tablespace.sql`
    - `data/db-load/db-load/oracle/load_lock_test.sql`
    - `data/db-load/db-load/oracle/load_insert_delete.sql`
    - `data/db-load/db-load/oracle/init_test_table.sql`
- **테스트 실행 스크립트:**
    - `data/db-load/db-load/oracle/run_load_test.sh`
      실행방법:  . /{파일명}
- **로그 파일들:**
    - `data/db-load/db-load/oracle/logs/session_*_load_*.log`


*init_test_table*
테스트에 필요한 table, data 준비 (기존 테스트 테이블 삭제 쿼리도 있기 때문에 여러번 돌려도 괜춘할듯!)

*load_temp_tablespace*
임시 테이블 스페이스 부하
임시 테이블스페이스에 큰 문자열을 저장하는 연산 반복*

*load_undo_tablespace*
UNDO 테이블스페이스 부하
ROLLBACK 없이 변경을 누적시켜 UNDO 테이블스페이스 사용 증가

*load_insert_delete*
insert, delete 반복 부하

*load_lock_test*
lock, deadlock 테스트
(하위 실습 참고)

### Lock 발생 시키기(PostgreSQL)
PostgreSQL에서 deadlock을 발생 시키고 Datadog으로 모니터링해보기!

1. 먼저 요로코롬 하나의 Database에 두개의 세션을 연결해둡니다.
저는 CLI 환경(psql), dbeaver에 연결해뒀습니다 (같은 유저로 로그인도 괜찮!)
![[DB 부하테스트-1738819481373.png]]

2. 테스트 테이블, 데이터 생성
```SQL
-- 테이블 생성
CREATE TABLE test_table (
id SERIAL PRIMARY KEY,
value TEXT
);

-- 데이터 삽입
INSERT INTO test_table (value) VALUES ('Row 1'), ('Row 2');
```

3. deadlock 걸기
첫번째 세션에서 (DBeaver에서)
```SQL
-- 트랜잭션 시작
BEGIN;

-- 첫 번째 세션에서 id=1을 먼저 잠금
UPDATE test_table SET value = 'Session1' WHERE id = 1;

-- 잠금이 유지된 상태로 대기 (Session 2 실행 기회 줌)
SELECT pg_sleep(5);

-- id=2 업데이트 시도 (데드락 발생 예상)
UPDATE test_table SET value = 'Session1' WHERE id = 2;

COMMIT;
```

두번째 세션에서 (CLI에서)
```SQL
BEGIN;
UPDATE test_table SET value = 'Session2' WHERE id = 2;
SELECT pg_sleep(5);
UPDATE test_table SET value = 'Session2' WHERE id = 1;
COMMIT;
```

하면 데드락 발생해서 두 트랜잭션 모두 종료되고 rollback 됨!
![[DB 부하테스트-1738819794974.png]]

4. Datadog에서 확인하기
대시보드 > Postgres - Overview에서 확인
![[DB 부하테스트-1738819877079.png]]

### Lock 발생 시키기(Oracle)
```SQL
-- test_user 생성되어 있는 상태

-- 사전 준비
SELECT *FROM lock_test_table2;

-- 테이블 생성
CREATE TABLE lock_test_table2 (
id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
value VARCHAR2(4000)
);
-- 데이터 삽입
INSERT INTO lock_test_table2 (value) VALUES ('Row 1');
INSERT INTO lock_test_table2 (value) VALUES ('Row 2');
COMMIT;
```

***Trouble Shooting***: PLS-00201: identifier 'DBMS_LOCK' must be declared
에러 날 경우
```SQL
--권한 주는 계정으로 들어가
conn system/oracle as sysdba
-- 확인
show user;
-- 락 잡을 수 있는 권한 줘
grant execute on dbms_lock to test_user;
```

session1 에서
```SQL
BEGIN
UPDATE lock_test_table2 SET value = 'LOCK TEST_1_1' WHERE id = 1;
DBMS_LOCK.SLEEP(10);
UPDATE lock_test_table2 SET value = 'LOCK TEST1_2' WHERE id = 2;
END;
/
```

session2 에서
```SQL
BEGIN
UPDATE lock_test_table2 SET value = 'LOCK TEST2_1' WHERE id = 2;
DBMS_LOCK.SLEEP(10);
UPDATE lock_test_table2 SET value = 'LOCK TEST2_2' WHERE id = 1;
END;
/
```

### db_load 파일 실행하기

**test 유저 생성, 권한부여**
```SQL
-- 1️⃣ 새로운 사용자 생성
CREATE USER test_user IDENTIFIED BY test_user 
DEFAULT TABLESPACE USERS 
TEMPORARY TABLESPACE TEMP 
QUOTA UNLIMITED ON USERS;

-- 2️⃣ 기본적인 접속 권한 부여 
GRANT CONNECT, RESOURCE TO test_user; 
-- 3️⃣ 추가적인 권한 부여 
GRANT CREATE SESSION TO test_user; 
GRANT CREATE TABLE TO test_user; 
GRANT CREATE ANY TABLE TO test_user;
GRANT CREATE VIEW TO test_user; 
GRANT UNLIMITED TABLESPACE TO test_user; 
GRANT CREATE PROCEDURE TO test_user;
```

**Ubuntu > Oracle 에 파일 넣기** 
압축 파일 넣기! oracle-home 에 넣기!! *Trouble shooting 참고*

**Oracle DB 접속**
```shell
sudo docker exec -it oracle19c /bin/bash
```


**압축 해제**
```shell
tar -xvf db-load.tar
```


**run_load_test 파일 수정하기**
1. init.sql 파일 이름 수정
2. lock 테스트 주석처리
3. 접속 정보 입력
```shell
DB_USER=test_user
DB_PASS=test_user
DB_SID=ORCL
```
저장하고 나와서

**실행하기**
```shell
./run_load_test.sh
bash -x run_load_test.sh # 디버깅모드
```




***Trouble Shooting***
- 디버깅
첨에 root 계정(?) tmaxtibero 계정에 넣고 DB 접속 코드 넣어서 실행시켰더니 아무 반응이 없음.
그래서 디버깅 모드 찍어봄
```shell
bash -x run_load_test.sh
```

![[DB 부하테스트-1739839551701.png]]
결과가 oracle접속 이후 아무것도 안함

아! 도커 접속 이후엔 스크립트 안먹는구나! 깨달음! (사실 그런게 맞는지는 몰겠음 추측임 일단 원인은 얘가 맞는듯)

- oracle-home에 파일 넣기
이게 ... 어떤건지 작성은 못하겠음
docker로 띄워져 있어도 어딘가에 저장은 해야할거잖아
어딘가에 환경설정 파일도 있어야하고
![[DB 부하테스트-1739839649384.png]]
<font color="#c0504d">추측상</font> oracle-19c에 데이터 저장하는거 같고, oracle-home이 참고 가능한 경로..? 환경설정 같은거 저장해두는 경로 같음
그래서 oracle-home에 db-load 파일을 넣으려고 했는데~ 권한 문제 남
```shell
sudo chmod 777 /home/tmaxtibero/oracle-home/
```
해결~

크하하  oracle-home 여기 넣으면 될 거 같단거 검색도 안해보고 그냥 추측이었는데 정답이엇삼~~ 
![[DB 부하테스트-1739840160962.png]]
짜잔~


